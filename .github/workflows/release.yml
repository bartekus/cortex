# SPDX-License-Identifier: AGPL-3.0-or-later
name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-rust:
    name: Build Rust (${{ matrix.output_name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Practical V1 set
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            output_name: linux_amd64

          - os: macos-latest
            target: x86_64-apple-darwin
            output_name: darwin_amd64

          - os: macos-latest
            target: aarch64-apple-darwin
            output_name: darwin_arm64

          - os: windows-latest
            target: x86_64-pc-windows-msvc
            output_name: windows_amd64

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: rust

      - name: Build (xray, cortex-mcp)
        shell: bash
        run: |
          cd rust
          cargo build -p xray -p cortex-mcp --release --target "${{ matrix.target }}"

      - name: Prepare artifacts
        shell: bash
        run: |
          rm -rf dist && mkdir -p dist
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cp "rust/target/${{ matrix.target }}/release/xray.exe" "dist/xray.exe"
            cp "rust/target/${{ matrix.target }}/release/cortex-mcp.exe" "dist/cortex-mcp.exe"
          else
            cp "rust/target/${{ matrix.target }}/release/xray" "dist/xray"
            cp "rust/target/${{ matrix.target }}/release/cortex-mcp" "dist/cortex-mcp"
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: rust-binaries-${{ matrix.output_name }}
          path: dist/*

  goreleaser:
    name: GoReleaser (bundle + publish)
    needs: build-rust
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Download Rust artifacts
        uses: actions/download-artifact@v4
        with:
          path: rust-dist
          pattern: rust-binaries-*
          merge-multiple: false

      - name: Show rust-dist layout
        run: ls -R rust-dist

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v5
        with:
          # Consider pinning this later; v5 is fine for now.
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
